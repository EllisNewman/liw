# Life in Weeks 基本设计书

本文档记录 Life in Weeks 项目的核心设计理念、系统结构与交互规范，作为开发与迭代的参考依据。

---

## 1. 系统概述

### 1.1 核心概念

Life in Weeks 采用**三层可视化架构**，将时间信息分层展示：

1. **基础层**：周格网格，提供时间线基础框架
2. **层级系统**：时间段维度的分类可视化
3. **标注系统**：时间点维度的标记可视化

### 1.2 设计灵感

参考 4X 类游戏（如《文明》）的地图可视化系统：
- 基础层对应游戏地图本身（地形、边界）
- 层级切换对应选择不同资源类型时地块的颜色变化
- 标注叠加对应勾选特定资源时地块上的图标标注

---

## 2. 系统结构总览

```
生命周历系统
│
├── 基础层：周格网格
│   └── 基础状态：已过/当前/未来
│
├── 层级系统（Layer System）
│   ├── 层级1：教育阶段
│   │   └── 时间段集合（每个时间段有颜色）
│   ├── 层级2：工作阶段
│   │   └── 时间段集合
│   └── 层级N：...
│
└── 标注系统（Annotation System）
    ├── 标注1：重要事件
    │   └── 事件集合（每个事件有图标）
    ├── 标注2：旅行
    │   └── 事件集合
    └── 标注N：...
```

---

## 3. 基础层：周格（Week Cell）

### 3.1 定义

每个周格代表人生中的一周，是可视化的最小单元。

### 3.2 基础状态

周格具有三种基础状态：

- **已过周**：已过去的周，显示为一种基础颜色
- **当前周**：当前所在的周，高亮显示
- **未来周**：尚未到来的周，显示为另一种基础颜色

### 3.3 作用

基础层提供时间线的基础框架，是所有层级和标注的载体。无论是否激活层级或标注，基础层始终可见。

---

## 4. 层级系统（Layer System）

### 4.1 定义

层级是一种**时间段集合**，用于将连续的时间段按照某种分类维度进行可视化染色。

### 4.2 核心特征

- **覆盖范围**：时间段（连续的多周）
- **视觉表现**：给相关周格染色
- **切换方式**：用户可以选择激活/关闭某个层级
- **互斥性**：同一时间点，通常只激活一个层级（是否允许多层级同时显示待定）

### 4.3 层级结构

一个层级包含多个时间段，每个时间段有：
- 起始周索引
- 结束周索引（包含）
- 标签（如"大学期间"）
- 颜色（该时间段在该层级中的显示颜色）

**示例结构**：
```
层级：教育阶段
├── 时间段1：小学期间 (2000-2006) → 颜色A
├── 时间段2：中学期间 (2006-2012) → 颜色B
├── 时间段3：大学期间 (2012-2016) → 颜色C
└── 时间段4：研究生期间 (2016-2018) → 颜色D
```

### 4.4 典型层级示例

- **教育阶段层级**：将人生划分为"小学期间""中学期间""大学期间"等时间段
- **工作阶段层级**：将人生划分为"第一份工作""第二份工作""自由职业"等时间段
- **居住地层级**：将人生划分为"北京期间""上海期间""海外期间"等时间段

### 4.5 交互逻辑

- 用户通过控制面板选择要激活的层级
- 激活后，该层级包含的所有时间段对应的周格会显示相应颜色
- 关闭层级后，周格恢复为基础颜色（已过/当前）
- 切换层级时应有平滑的过渡动画

### 4.6 视觉表现规则

- 层级颜色优先于基础颜色：当层级激活时，相关周格的颜色由层级决定
- 当前周高亮保留：当前周即使属于某个层级，也应保持高亮效果
- 时间段边界渐变：相邻时间段之间可以使用渐变色实现平滑过渡

---

## 5. 标注系统（Annotation System）

### 5.1 定义

标注是一种**时间点事件集合**，用于在特定周格上显示图标或标记，强调重要事件。

### 5.2 核心特征

- **覆盖范围**：时间点（单周）
- **视觉表现**：在周格上显示图标/标记
- **切换方式**：用户可以选择激活/关闭某个标注分类
- **叠加性**：多个标注分类可以同时激活，同一周格上可以显示多个图标

### 5.3 标注结构

一个标注包含多个事件，每个事件有：
- 周索引（事件发生的周）
- 标签（如"毕业"）
- 图标（该事件在该标注分类中的显示图标）
- 可选：精确日期、描述等

**示例结构**：
```
标注：重要事件
├── 事件1：毕业 (2016-06) → 图标A
├── 事件2：入职 (2018-03) → 图标B
└── 事件3：结婚 (2020-09) → 图标C

标注：旅行
├── 事件1：日本旅行 (2019-07) → 图标D
└── 事件2：欧洲旅行 (2021-08) → 图标E
```

### 5.4 典型标注示例

- **重要事件标注**：包含"毕业""入职""结婚"等事件
- **旅行标注**：包含所有旅行事件
- **健康记录标注**：包含体检、手术等健康相关事件

### 5.5 交互逻辑

- 用户通过控制面板勾选要显示的标注分类（可多选）
- 激活后，该标注分类下的所有事件对应的周格上会显示相应图标
- 多个标注同时激活时，同一周格上可以叠加显示多个图标
- 切换标注时应有平滑的过渡动画

### 5.6 视觉表现规则

- 标注图标叠加在层级颜色之上：图标显示在周格的上层（视觉上覆盖在层级颜色之上）
- 图标清晰可见：图标应保持清晰可见，不因层级颜色而难以识别
- 多图标布局：当一个周格上有多个标注图标时，需要合理的布局策略（如图标堆叠、小图标阵列等）

---

## 6. 层级与标注的关系

### 6.1 概念层面的关系

**互补性**
- **层级**：回答"这段时间属于哪个阶段？"（时间段维度）
- **标注**：回答"这个时间点发生了什么？"（时间点维度）

**独立性**
- 层级和标注是**独立的概念**，可以单独使用，也可以组合使用
- 一个时间段可以属于某个层级，同时该时间段内的某些周格也可以有标注

**叠加性**
- 层级和标注可以**同时激活**
- 当层级和标注同时激活时：
  - 周格的基础颜色由层级决定（如果该周格属于激活层级的时间段）
  - 周格上的图标由激活的标注决定（如果该周格有对应的事件）

### 6.2 视觉层次关系

周格视觉层次（从底到顶）：
```
┌─────────────────────────┐
│ 1. 基础颜色层            │  ← 已过/当前/未来
├─────────────────────────┤
│ 2. 层级颜色层            │  ← 已过/当前（未来周格不受影响->除非将来加入“计划”功能）
│    （按层级顺序依次叠加）  │
├─────────────────────────┤
│ 3. 标注图标层            │  ← 事件图标
└─────────────────────────┘
```

**规则**：
- 层级颜色优先于基础颜色
- 层级颜色按层级顺序依次显示
- 标注图标叠加在层级颜色之上
- 当前周的高亮效果始终保留

---

## 7. 用户交互设计

### 7.1 控制面板

用户通过控制面板管理层级和标注的显示：

**层级控制**：
- 显示所有可用的层级列表
- 每个层级有开关（toggle），用于激活/关闭
- 点击层级名称可显示层级到图表
- 点击层级名称旁边的编辑按钮可打开编辑窗口

**标注控制**：
- 显示所有可用的标注分类列表
- 每个标注有复选框（checkbox），支持多选
- 点击标注名称可显示标注到图表
- 点击标注名称旁边的编辑按钮可打开编辑窗口

### 7.2 编辑窗口

编辑窗口用于对层级和标注进行增删改查操作，采用**模态框（Modal）**形式实现。

#### 7.2.1 实现方式

**技术方案**：
- 使用原生 HTML + CSS + Vue 3 实现，不引入第三方 UI 库
- 模态框使用固定定位的遮罩层（backdrop）和居中显示的内容区域
- 使用 CSS 过渡动画实现淡入淡出效果

**交互特性**：
- 模态框打开时，阻止用户操作背景内容（模态框独占焦点）
- 点击遮罩层或按 ESC 键可关闭模态框
- 关闭前如有未保存更改，可提示用户确认

#### 7.2.2 层级编辑窗口

**触发方式**：
- 在控制面板的层级项右侧显示"编辑"按钮
- 点击编辑按钮后打开层级编辑窗口

**窗口布局**：
```
┌─────────────────────────────────────────┐
│  编辑层级：教育阶段                [×]  │
├─────────────────────────────────────────┤
│                                         │
│  层级名称：[教育阶段            ]       │
│  默认颜色：[████]                       │
│                                         │
│  时间段列表：                            │
│  ┌───────────────────────────────────┐ │
│  │ 1. 小学期间                        │ │
│  │    起始日期：[2000-01-01]         │ │
│  │    结束日期：[2006-06-30]         │ │
│  │    标签：[小学期间        ]       │ │
│  │    颜色：[████] [删除]            │ │
│  ├───────────────────────────────────┤ │
│  │ 2. 中学期间                        │ │
│  │    起始日期：[2006-09-01]         │ │
│  │    结束日期：[2012-06-30]         │ │
│  │    标签：[中学期间        ]       │ │
│  │    颜色：[████] [删除]            │ │
│  └───────────────────────────────────┘ │
│                                         │
│  [+ 添加时间段]                         │
│                                         │
│              [取消]  [保存]             │
└─────────────────────────────────────────┘
```

**功能说明**：
- **层级基本信息**：
  - 层级名称：文本输入框
  - 默认颜色：颜色选择器（原生 `<input type="color">`）
- **时间段管理**：
  - 显示该层级下的所有时间段列表
  - 每个时间段包含：起始日期、结束日期、标签、颜色
  - 支持添加新时间段、删除现有时间段
  - 时间段编辑采用内联方式（直接在列表中编辑）
- **操作按钮**：
  - 取消：关闭窗口，丢弃所有更改
  - 保存：应用更改并更新视图

**数据同步**：
- 编辑窗口打开时，创建层级数据的临时副本
- 用户在临时副本上进行编辑操作
- 点击"保存"时，将临时副本的数据同步到原始数据，并触发视图更新
- 点击"取消"或关闭窗口时，丢弃临时副本，不修改原始数据

**数据优化**（代码层面）：
- 如果时间段的起始日期大于结束日期，在保存到数据结构时自动交换两者
- 确保时间段数据的有效性，避免显示错误

#### 7.2.3 标注编辑窗口

**触发方式**：
- 在控制面板的标注项右侧显示"编辑"按钮
- 点击编辑按钮后打开标注编辑窗口

**窗口布局**：
```
┌─────────────────────────────────────────┐
│  编辑标注：重要事件                [×]  │
├─────────────────────────────────────────┤
│                                         │
│  标注名称：[重要事件            ]       │
│  图标：[⭐]                              │
│                                         │
│  事件列表：                              │
│  ┌───────────────────────────────────┐ │
│  │ 1. 高中毕业                        │ │
│  │    日期：[2014-06-15]             │ │
│  │    标签：[高中毕业        ]       │ │
│  │    图标：[🎓] [删除]               │ │
│  ├───────────────────────────────────┤ │
│  │ 2. 大学毕业                        │ │
│  │    日期：[2018-06-20]             │ │
│  │    标签：[大学毕业        ]       │ │
│  │    图标：[🎓] [删除]               │ │
│  └───────────────────────────────────┘ │
│                                         │
│  [+ 添加事件]                           │
│                                         │
│              [取消]  [保存]             │
└─────────────────────────────────────────┘
```

**功能说明**：
- **标注基本信息**：
  - 标注名称：文本输入框
  - 图标：文本输入框（PoC 阶段使用文本输入，支持 emoji 或 Unicode 字符）
- **事件管理**：
  - 显示该标注下的所有事件列表
  - 每个事件包含：日期、标签、图标
  - 支持添加新事件、删除现有事件
  - 事件编辑采用内联方式（直接在列表中编辑）
- **操作按钮**：
  - 取消：关闭窗口，丢弃所有更改
  - 保存：应用更改并更新视图

**数据同步**：
- 编辑窗口打开时，创建标注数据的临时副本
- 用户在临时副本上进行编辑操作
- 点击"保存"时，将临时副本的数据同步到原始数据，并触发视图更新
- 点击"取消"或关闭窗口时，丢弃临时副本，不修改原始数据

#### 7.2.4 视觉设计要点

**模态框样式**：
- 遮罩层：半透明黑色背景，覆盖整个屏幕
- 内容区域：居中显示，使用与主界面一致的设计风格
- 最大宽度：600px（层级编辑）或 500px（标注编辑）
- 最大高度：80vh，超出部分可滚动
- 圆角：与主界面一致的圆角值

**动画效果**：
- 打开：遮罩层淡入（0.2s），内容区域从下方滑入（0.2s）
- 关闭：遮罩层淡出（0.2s），内容区域向下滑出（0.2s）

**表单元素**：
- 使用原生 HTML 表单元素（`<input>`、`<button>` 等）
- 样式与主界面保持一致
- 日期选择器使用原生 `<input type="date">`
- 颜色选择器使用原生 `<input type="color">`
- 图标输入：PoC 阶段使用文本输入框（`<input type="text">`），支持 emoji 或 Unicode 字符输入

### 7.3 典型使用场景

**场景1：查看教育阶段**
1. 用户激活"教育阶段"层级
2. 周格根据教育阶段显示不同颜色（小学/中学/大学等）
3. 用户可以同时激活"重要事件"标注，查看教育阶段中的重要事件

**场景2：查看工作经历**
1. 用户激活"工作阶段"层级
2. 周格根据工作阶段显示不同颜色
3. 用户可以激活"旅行"标注，查看工作期间的旅行安排

**场景3：仅查看事件**
1. 用户不激活任何层级（保持基础颜色）
2. 用户激活多个标注分类（如"重要事件""旅行"）
3. 周格保持基础颜色，但显示所有激活标注的事件图标

### 7.4 交互反馈

- 切换层级/标注时，使用平滑的过渡动画（淡入淡出，0.2-0.3s）
- 悬停周格时，显示该周对应的日期范围与事件信息
- 点击周格时，可进行编辑或查看详情

---

## 8. 设计原则

### 8.1 信息分层原则

- **基础层**：提供时间线框架，始终可见
- **层级**：提供时间段维度的分类视图，按需激活
- **标注**：提供时间点维度的标记视图，按需激活

### 8.2 视觉清晰原则

- 层级颜色应清晰区分不同时间段
- 标注图标应清晰可见，不因层级颜色而难以识别
- 当前周的高亮效果应始终保留

### 8.3 交互简洁原则

- 层级和标注的激活/关闭操作应简单直观
- 控制面板应清晰展示所有可用的层级和标注
- 切换层级/标注时应有平滑的过渡动画

### 8.4 可扩展性原则

- 用户可以创建自定义层级（定义自己的时间段分类）
- 用户可以创建自定义标注（定义自己的事件分类）
- 系统应支持导入/导出层级和标注配置

---

## 9. 待定问题与后续讨论

以下问题需要在后续设计或 MVP 验证阶段确定：

### 9.1 多层级同时显示

**问题**：是否允许用户同时激活多个层级？

**影响**：
- 如果允许，需要确定多个层级的颜色如何叠加/混合
- 如果不允许，需要确定层级切换的交互方式（单选 vs 多选）

**建议**：MVP 阶段先实现单层级激活，后续根据用户反馈评估多层级需求。

### 9.2 层级优先级

**问题**：如果同一时间段属于多个层级，当多个层级同时激活时，如何决定显示哪个层级的颜色？

**影响**：
- 需要定义层级优先级规则
- 或者采用颜色混合策略

**建议**：待多层级同时显示功能确定后再讨论。

### 9.3 标注图标布局

**问题**：当一个周格上有多个标注图标时，如何排列以避免视觉混乱？

**影响**：
- 需要设计图标布局算法
- 需要考虑图标大小、间距、堆叠方式等

**建议**：MVP 阶段先实现基础布局（如中心对齐、小图标阵列），后续根据实际使用情况优化。

### 9.4 时间段边界处理

**问题**：时间段之间的边界如何精确处理？是否允许时间段重叠或间隙？

**影响**：
- 需要定义时间段的边界规则
- 需要处理边界情况的视觉表现

**建议**：MVP 阶段先支持连续时间段，后续根据需求评估重叠/间隙场景。

---

## 10. 持久化存储设计

### 10.1 目标与范围

- **目标**：
  - 在浏览器本地保存用户配置与里程碑数据，使用户再次打开页面时自动恢复上次状态
  - 支持将当前数据导出为 JSON 文件，以及从 JSON 文件恢复
  - 支持一键清除所有本地数据，回到初始状态
- **范围**：
  - 覆盖基础配置（出生日期、总周数、列数等）
  - 覆盖层级配置（层级列表与时间段）
  - 覆盖标注配置（标注分类与事件）
  - 不强制保存纯 UI 派生信息（如当前 hover 状态、临时弹窗状态）

### 10.2 持久化数据结构概览

持久化数据以单一顶层对象形式保存，以下为逻辑结构：

- **顶层字段**：
  - 应用版本标识（例如 `schemaVersion`），用于未来兼容与迁移
  - 基础配置：
    - 出生日期（yyyyMMdd）
    - 总周数
    - 列数（每行多少周）
    - 其他基础显示参数（如周起始日、语言环境等，如有）
  - 层级配置数组：
    - 每个层级包含：唯一 ID、名称、默认颜色、时间段列表
    - 时间段包含：起始周索引、结束周索引、标签、颜色
  - 标注配置数组：
    - 每个标注包含：唯一 ID、名称、图标、事件列表
    - 事件包含：周索引或日期、标签、图标

结构层次：

- 顶层对象
  - `meta`：存放 `schemaVersion` 等元信息
  - `settings`：基础配置（出生日期、总周数、列数等）
  - `layers`：层级数组，各层级包含其时间段
  - `annotations`：标注数组，各标注包含其事件

其中 `layers` 与 `annotations` 的结构与第 4 章、第 5 章中描述的概念模型保持一致，以便编辑窗口与渲染逻辑直接复用同一数据结构。

### 10.3 存储介质与键设计

- **存储介质**：
  - MVP / PoC 阶段优先使用 `localStorage`
  - 未来如有需要，可在不改变文档约定的前提下，引入 IndexedDB 以支持更大数据量或版本迁移
- **存储键设计**：
  - 使用固定命名空间前缀，例如：`lifeInWeeks.state.v1`
  - 后续如有不兼容变更，可通过变更版本号（如 `v2`）并在加载时进行区分
- **存储内容**：
  - 将完整顶层对象序列化为 JSON 字符串存入 `localStorage`
  - 建议确保序列化结果中不包含仅与运行时相关的临时字段（例如编辑窗口内部的临时副本）

### 10.4 页面生命周期与同步策略

#### 10.4.1 页面启动流程

1. 页面加载时：
   - 尝试从 `localStorage` 读取持久化数据
   - 如读取成功且结构与 `schemaVersion` 合法，则：
     - 使用持久化数据初始化基础配置、层级与标注
     - 计算当前周索引与周格数组（依据出生日期与当前日期）
   - 如读取失败或数据非法，则：
     - 使用默认配置（例如默认总周数、默认列数）
     - 将界面视为“初始状态”，等待用户输入后再保存

2. 从 JSON 文件导入时：
   - 文件读取与解析成功后，将文件中的数据视为新的“持久化状态来源”
   - 用导入的数据覆盖当前内存中的配置与里程碑数据
   - 重新计算当前周索引与周格数组
   - 将导入的数据写入 `localStorage`（保持一致）

#### 10.4.2 数据变更与保存策略

- 触发持久化保存的典型操作：
  - 用户点击“生成生命周历”按钮，完成基础配置
  - 用户在层级编辑窗口中新增/修改/删除时间段，并点击“保存”
  - 用户在标注编辑窗口中新增/修改/删除事件，并点击“保存”
  - 用户从导入文件成功恢复数据
- 保存策略：
  - 每次上述操作完成后，将当前内存状态序列化并写入 `localStorage`
  - 考虑异步操作，不阻塞当前处理
  - 考虑简单的节流/防抖策略，避免短时间内多次重复写入
- 数据校正：
  - 在持久化前，对明显错误的数据进行简单修正：
    - 如时间段的起始周大于结束周，则自动交换两者
    - 如事件日期无法转化为有效周索引，则可暂时跳过或记录为“无效条目”（具体策略由实现决定）

### 10.5 导入 / 导出 / 清除 按钮设计

在主界面右上区域（靠近标题或整体容器右上角）设置三个按钮：

- **导入**：
  - 位置：标题区域或全局操作区域的右侧
  - 行为：
    - 触发文件选择对话框，允许用户从本地选择 JSON 文件
    - 解析文件内容为持久化数据对象
    - 对数据结构进行基本检查（例如必需字段是否存在）
    - 如解析成功，则按照 10.4.1 中“从 JSON 文件导入”的流程覆盖当前状态并写入 `localStorage`
    - 如解析失败，则提示用户文件无效，不改变当前状态
- **导出**：
  - 行为：
    - 从当前内存状态构造一个完整的持久化数据对象
    - 序列化为 JSON，并触发浏览器下载为文件（例如 `life-in-weeks-export.json`）
    - 不改变当前应用状态
- **清除**：
  - 行为：
    - 提示用户确认是否清除本地所有数据，是否执行一次导出然后清除
    - 确认后：
      - 如用户同意，则执行一次导出行为并等待其完成
      - 清除与本应用相关的 `localStorage` 键值（例如 `lifeInWeeks.state.v1`）
      - 将内存状态重置为初始值（如同首次进入页面）
      - 可选择通过刷新页面或调用“重置逻辑”实现

### 10.6 错误处理与兼容性

- **读取错误**：
  - 从 `localStorage` 读取到的数据无法解析为 JSON 或结构不符合预期时，应忽略该数据并使用默认配置启动
- **版本兼容**：
  - 依据 `schemaVersion` 判断数据版本：
    - 当前版本不识别的旧版本数据，可选择：
      - 进行简单字段映射升级
      - 或提示用户“数据版本过旧”，建议清除或重新导入
- **导入兼容**：
  - 导入文件的 `schemaVersion` 不匹配当前版本时，可采用与上述类似策略处理

---

## 11. 与项目其他部分的关系

### 11.1 与基础信息的关系

层级和标注系统建立在基础信息（出生日期、总周数等）之上，依赖基础信息计算周索引；基础信息本身作为持久化状态的一部分，由第 10 章所述的存储方案统一管理。

### 11.2 与里程碑概念的关系

层级和标注系统是对原有"里程碑"概念的细化：
- **层级**对应"时间段"类型的里程碑
- **标注**对应"时间点事件"类型的里程碑

### 11.3 与数据存储的关系

本项目的本地数据存储（包括基础配置、层级与标注）遵循第 10 章中定义的持久化存储设计：
- 页面启动、导入/导出、编辑窗口保存等操作均通过统一的数据结构与存储键进行读写
- 具体技术实现可基于 `localStorage` 与 JSON 序列化，必要时扩展至 IndexedDB

---

## 附录：术语表

- **周格（Week Cell）**：代表一周的网格单元
- **层级（Layer）**：时间段集合，用于给周格染色
- **时间段（Time Range）**：层级中的一个连续时间区间
- **标注（Annotation）**：时间点事件集合，用于在周格上显示图标
- **事件（Event）**：标注中的一个时间点事件
- **激活（Activate）**：用户选择显示某个层级或标注
- **基础颜色**：周格的基础状态颜色（已过/当前/未来）
