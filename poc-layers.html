<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Life in Weeks ‚Äì Layers & Annotations PoC</title>
    <style>
      :root {
        color-scheme: light dark;
        --bg: #0b0c10;
        --bg-elevated: #151822;
        --fg: #f5f5f7;
        --muted: #8b8fa3;
        --accent: #4f8df5;
        --past: #4f8df5;
        --current: #f5b64f;
        --future: #2a3140;
        --border-subtle: #212633;
        --radius-lg: 16px;
        --radius-sm: 4px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
          "Segoe UI", sans-serif;
        background: radial-gradient(circle at top, #15192a 0, #05060a 60%);
        color: var(--fg);
        display: flex;
        align-items: stretch;
        justify-content: center;
        padding: 24px;
      }

      .shell-light {
        width: 100%;
        max-width: 1120px;
        background: linear-gradient(145deg, #f5f7ff 0, #050608 60%, #b9b9bb 100%);
        border-radius: 24px;
        border: 1px solid rgba(255, 255, 255, 0.05);
        box-shadow:
          0 18px 60px rgba(0, 0, 0, 0.75),
          0 0 0 1px rgba(255, 255, 255, 0.02);
        padding: 20px 22px 24px;
        display: flex;
        flex-direction: column;
        gap: 18px;
      }

      .shell-dark {
        width: 100%;
        max-width: 1120px;
        background: linear-gradient(145deg, #12100b 0, #050608 60%, #0f1019 100%);
        border-radius: 24px;
        border: 1px solid rgba(255, 255, 255, 0.05);
        box-shadow:
          0 18px 60px rgba(0, 0, 0, 0.75),
          0 0 0 1px rgba(255, 255, 255, 0.02);
        padding: 20px 22px 24px;
        display: flex;
        flex-direction: column;
        gap: 18px;
      }

      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
      }

      .title-block {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      h1 {
        margin: 0;
        font-size: 20px;
        font-weight: 600;
        letter-spacing: 0.02em;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .badge {
        font-size: 11px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(255, 255, 255, 0.02);
        color: var(--muted);
      }

      .subtitle {
        margin: 0;
        font-size: 13px;
        color: var(--muted);
      }

      form {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: flex-end;
      }

      .field {
        display: flex;
        flex-direction: column;
        gap: 4px;
        min-width: 140px;
      }

      label {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        color: var(--muted);
      }

      input[type="date"],
      input[type="number"] {
        appearance: none;
        padding: 7px 10px;
        border-radius: 999px;
        border: 1px solid var(--border-subtle);
        background: rgba(255, 255, 255, 0.03);
        color: var(--fg);
        font-size: 13px;
        outline: none;
        min-height: 32px;
      }

      input[type="date"]:focus,
      input[type="number"]:focus {
        border-color: rgba(79, 141, 245, 0.8);
        box-shadow: 0 0 0 1px rgba(79, 141, 245, 0.6);
      }

      button {
        border: none;
        cursor: pointer;
        border-radius: 999px;
        padding: 8px 18px;
        font-size: 13px;
        font-weight: 500;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        background: radial-gradient(circle at top left, #5f8fff 0, #3555ff 50%, #1e2a80 100%);
        color: white;
        box-shadow:
          0 10px 30px rgba(39, 88, 255, 0.55),
          0 0 0 1px rgba(255, 255, 255, 0.06);
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      button span.dot {
        width: 6px;
        height: 6px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.9);
      }

      button:active {
        transform: translateY(1px);
        box-shadow:
          0 4px 20px rgba(39, 88, 255, 0.55),
          0 0 0 1px rgba(255, 255, 255, 0.06);
      }

      main {
        display: grid;
        grid-template-columns: minmax(0, 2.3fr) minmax(0, 1fr);
        gap: 18px;
        align-items: stretch;
      }

      @media (max-width: 800px) {
        body {
          padding: 12px;
        }

        .shell {
          padding: 16px 14px 18px;
        }

        main {
          grid-template-columns: minmax(0, 1fr);
        }
      }

      .panel {
        border-radius: var(--radius-lg);
        background: radial-gradient(circle at top, #181b26 0, #080910 52%);
        border: 1px solid rgba(255, 255, 255, 0.04);
        padding: 14px 14px 16px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        min-height: 260px;
      }

      .panel-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        font-size: 12px;
        color: var(--muted);
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .grid-wrapper {
        position: relative;
        flex: 1;
        overflow: hidden;
        border-radius: 12px;
        background: radial-gradient(circle at top left, #171b28 0, #05060b 60%);
        border: 1px solid rgba(255, 255, 255, 0.03);
      }

      .weeks-grid {
        --cols: 52;
        --gap: 1px;
        --cell-size: 10px;
        display: grid;
        grid-template-columns: repeat(var(--cols), var(--cell-size));
        grid-auto-rows: var(--cell-size);
        gap: var(--gap);
        padding: 10px;
        align-content: start;
        justify-content: start;
      }

      .week-cell {
        border-radius: 2px;
        background: var(--future);
        transition:
          background 200ms ease-out,
          box-shadow 200ms ease-out;
        width: 100%;
        height: 100%;
        position: relative;
      }

      .week-cell.past {
        background: radial-gradient(circle at top, #4f8df5 0, #3558c8 60%);
      }

      .week-cell.current {
        background: radial-gradient(circle at top left, #ffc15a 0, #f39c3c 60%);
        box-shadow: 0 0 0 1px rgba(255, 188, 79, 0.8);
      }

      .grid-empty {
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--muted);
        font-size: 13px;
        padding: 24px 16px;
      }

      /* Â±ÇÁ∫ßÂíåÊ†áÊ≥®ÊéßÂà∂Èù¢ÊùøÊ†∑Âºè */
      .controls-panel {
        display: flex;
        flex-direction: column;
        gap: 16px;
        max-height: 600px;
        overflow-y: auto;
      }

      .control-section {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .control-section-title {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        color: var(--muted);
        font-weight: 600;
      }

      .layer-item,
      .annotation-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 10px;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.05);
        transition: all 150ms ease-out;
      }

      .layer-item:hover,
      .annotation-item:hover {
        background: rgba(255, 255, 255, 0.04);
        border-color: rgba(255, 255, 255, 0.1);
      }

      .layer-item.active,
      .annotation-item.active {
        background: rgba(79, 141, 245, 0.1);
        border-color: rgba(79, 141, 245, 0.3);
      }

      .layer-toggle {
        width: 36px;
        height: 20px;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.15);
        position: relative;
        cursor: pointer;
        transition: all 200ms ease-out;
        flex-shrink: 0;
      }

      .layer-toggle.active {
        background: var(--accent);
        border-color: var(--accent);
      }

      .layer-toggle::after {
        content: "";
        position: absolute;
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: white;
        top: 2px;
        left: 2px;
        transition: transform 200ms ease-out;
      }

      .layer-toggle.active::after {
        transform: translateX(16px);
      }

      .annotation-checkbox {
        width: 18px;
        height: 18px;
        border-radius: 4px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        background: rgba(255, 255, 255, 0.05);
        cursor: pointer;
        position: relative;
        flex-shrink: 0;
        transition: all 150ms ease-out;
      }

      .annotation-checkbox.checked {
        background: var(--accent);
        border-color: var(--accent);
      }

      .annotation-checkbox.checked::after {
        content: "‚úì";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 12px;
        font-weight: bold;
      }

      .layer-label,
      .annotation-label {
        flex: 1;
        font-size: 13px;
        color: var(--fg);
        cursor: pointer;
      }

      .layer-color-preview {
        width: 20px;
        height: 20px;
        border-radius: 4px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        flex-shrink: 0;
      }

      .annotation-icon {
        width: 16px;
        height: 16px;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      /* Âë®Ê†º‰∏äÁöÑÊ†áÊ≥®ÂõæÊ†á */
      .week-cell .annotation-icon-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 60%;
        height: 60%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        pointer-events: none;
        z-index: 2;
      }

      .week-cell .annotation-icons-stack {
        display: flex;
        flex-wrap: wrap;
        gap: 1px;
        align-items: center;
        justify-content: center;
      }

      .week-cell .annotation-icon-small {
        font-size: 8px;
        line-height: 1;
      }

      /* ÁºñËæëÊåâÈíÆ */
      .edit-btn {
        padding: 4px 8px;
        font-size: 11px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 4px;
        color: var(--muted);
        cursor: pointer;
        transition: all 150ms ease-out;
        flex-shrink: 0;
      }

      .edit-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.2);
        color: var(--fg);
      }

      /* Ê®°ÊÄÅÊ°Ü */
      .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 24px;
        animation: fadeIn 0.2s ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .modal-content {
        background: linear-gradient(145deg, #181b26 0, #080910 60%);
        border-radius: var(--radius-lg);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
        max-width: 600px;
        max-height: 80vh;
        width: 100%;
        display: flex;
        flex-direction: column;
        animation: slideUp 0.2s ease-out;
        overflow: hidden;
      }

      .modal-header {
        padding: 20px 24px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-shrink: 0;
      }

      .modal-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--fg);
      }

      .modal-close {
        width: 32px;
        height: 32px;
        border: none;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        color: var(--muted);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        transition: all 150ms ease-out;
      }

      .modal-close:hover {
        background: rgba(255, 255, 255, 0.1);
        color: var(--fg);
      }

      .modal-body {
        padding: 24px;
        overflow-y: auto;
        flex: 1;
      }

      .modal-footer {
        padding: 16px 24px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        flex-shrink: 0;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-label {
        display: block;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--muted);
        margin-bottom: 8px;
        font-weight: 600;
      }

      .form-input {
        width: 100%;
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid var(--border-subtle);
        background: rgba(255, 255, 255, 0.03);
        color: var(--fg);
        font-size: 14px;
        outline: none;
        transition: all 150ms ease-out;
      }

      .form-input:focus {
        border-color: rgba(79, 141, 245, 0.8);
        box-shadow: 0 0 0 1px rgba(79, 141, 245, 0.6);
      }

      .form-input[type="color"] {
        height: 40px;
        padding: 4px;
        cursor: pointer;
      }

      .ranges-list,
      .events-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-top: 12px;
      }

      .range-item,
      .event-item {
        padding: 16px;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .range-item-header,
      .event-item-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 13px;
        font-weight: 500;
        color: var(--fg);
      }

      .range-item-fields,
      .event-item-fields {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      .range-item-fields.full-width {
        grid-template-columns: 1fr;
      }

      .range-item-fields.two-col {
        grid-template-columns: 1fr 1fr;
      }

      .btn-secondary {
        padding: 8px 16px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(255, 255, 255, 0.05);
        color: var(--fg);
        cursor: pointer;
        font-size: 13px;
        transition: all 150ms ease-out;
      }

      .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.2);
      }

      .btn-primary {
        padding: 8px 20px;
        border-radius: 8px;
        border: none;
        background: radial-gradient(
          circle at top left,
          #5f8fff 0,
          #3555ff 50%,
          #1e2a80 100%
        );
        color: white;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        transition: all 150ms ease-out;
      }

      .btn-primary:hover {
        opacity: 0.9;
        transform: translateY(-1px);
      }

      .btn-danger {
        padding: 6px 12px;
        border-radius: 6px;
        border: 1px solid rgba(255, 100, 100, 0.3);
        background: rgba(255, 100, 100, 0.1);
        color: #ff6464;
        cursor: pointer;
        font-size: 12px;
        transition: all 150ms ease-out;
      }

      .btn-danger:hover {
        background: rgba(255, 100, 100, 0.2);
        border-color: rgba(255, 100, 100, 0.5);
      }

      .btn-add {
        padding: 10px 16px;
        border-radius: 8px;
        border: 1px dashed rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.02);
        color: var(--muted);
        cursor: pointer;
        font-size: 13px;
        transition: all 150ms ease-out;
        display: flex;
        align-items: center;
        gap: 8px;
        justify-content: center;
      }

      .btn-add:hover {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.3);
        color: var(--fg);
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="shell shell-dark">
        <header>
          <div class="title-block">
            <h1>
              Life in Weeks
              <span class="badge">Â±ÇÁ∫ß‰∏éÊ†áÊ≥® PoC</span>
            </h1>
            <p class="subtitle">
              ‰∏ÄÊ†º‰ª£Ë°®‰∏ÄÂë®„ÄÇËæìÂÖ•Âá∫ÁîüÊó•ÊúüÔºåÊü•ÁúãÂΩìÂâçÂë®ÂéÜ„ÄÇ
            </p>
          </div>
          <div style="display: flex; gap: 8px; align-items: center">
            <button type="button" class="btn-secondary" @click="handleImportClick">
              ÂØºÂÖ•
            </button>
            <button type="button" class="btn-secondary" @click="exportData">
              ÂØºÂá∫
            </button>
            <button type="button" class="btn-danger" @click="clearData">
              Ê∏ÖÈô§
            </button>
            <input
              ref="importInput"
              type="file"
              accept="application/json"
              style="display: none"
              @change="handleFileChange"
            />
          </div>
        </header>

        <form @submit.prevent="generateGrid">
          <div class="field">
            <label for="birth">Âá∫ÁîüÊó•Êúü</label>
            <input
              id="birth"
              v-model="birthDate"
              type="date"
              required
            />
          </div>
          <div class="field">
            <label for="totalWeeks">ÊÄªÂë®Êï∞</label>
            <input
              id="totalWeeks"
              v-model.number="totalWeeks"
              type="number"
              min="52"
              max="8000"
              step="1"
            />
          </div>
          <div class="field">
            <label for="ageYears">Âπ¥ÈæÑ</label>
            <input
              id="ageYears"
              v-model.number="ageYears"
              type="number"
              min="1"
              max="120"
              step="1"
              inputmode="numeric"
            />
          </div>
          <div class="field">
            <label for="colsPerRow">ÂàóÊï∞</label>
            <input
              id="colsPerRow"
              v-model.number="colsPerRow"
              type="number"
              min="10"
              max="120"
              step="1"
            />
          </div>
          <button type="submit">
            <span class="dot"></span>
            ÁîüÊàêÁîüÂëΩÂë®ÂéÜ
          </button>
        </form>

        <main>
          <section class="panel">
            <div class="panel-header">
              <span>ÁîüÂëΩÂë®Ê†º</span>
            </div>
            <div class="grid-wrapper">
              <div v-if="!hasData" class="grid-empty">
                ËøòÊ≤°ÊúâÊï∞ÊçÆ„ÄÇÂ°´ÂÜô‰∏äÊñπ‰ø°ÊÅØÂπ∂ÁÇπÂáª„ÄåÁîüÊàêÁîüÂëΩÂë®ÂéÜ„Äç„ÄÇ
              </div>
              <div
                v-else
                ref="gridEl"
                class="weeks-grid"
                :style="gridStyle"
              >
                <div
                  v-for="(week, index) in weeks"
                  :key="index"
                  class="week-cell"
                  :class="getWeekCellClasses(week, index)"
                  :style="getWeekCellStyle(week, index)"
                >
                  <div
                    v-if="getWeekAnnotations(index).length > 0"
                    class="annotation-icon-overlay"
                  >
                    <div class="annotation-icons-stack">
                      <span
                        v-for="(icon, i) in getWeekAnnotations(index)"
                        :key="i"
                        class="annotation-icon-small"
                        :title="icon.label"
                      >
                        {{ icon.icon }}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <section class="panel">
            <div class="panel-header">
              <span>Â±ÇÁ∫ß‰∏éÊ†áÊ≥®ÊéßÂà∂</span>
            </div>
            <div class="controls-panel">
              <!-- Â±ÇÁ∫ßÁ≥ªÁªü -->
              <div class="control-section">
                <div class="control-section-title">Â±ÇÁ∫ß</div>
                <div
                  v-for="layer in layers"
                  :key="layer.id"
                  class="layer-item"
                  :class="{ active: layer.active }"
                >
                  <div
                    class="layer-toggle"
                    :class="{ active: layer.active }"
                    @click="toggleLayer(layer.id)"
                  ></div>
                  <div
                    class="layer-color-preview"
                    :style="{ background: layer.color }"
                  ></div>
                  <span class="layer-label" @click="toggleLayer(layer.id)">
                    {{ layer.name }}
                  </span>
                  <button class="edit-btn" @click.stop="openLayerEdit(layer.id)">
                    ÁºñËæë
                  </button>
                </div>
              </div>

              <!-- Ê†áÊ≥®Á≥ªÁªü -->
              <div class="control-section">
                <div class="control-section-title">Ê†áÊ≥®</div>
                <div
                  v-for="annotation in annotations"
                  :key="annotation.id"
                  class="annotation-item"
                  :class="{ active: annotation.active }"
                >
                  <div
                    class="annotation-checkbox"
                    :class="{ checked: annotation.active }"
                    @click="toggleAnnotation(annotation.id)"
                  ></div>
                  <span class="annotation-icon">{{ annotation.icon }}</span>
                  <span
                    class="annotation-label"
                    @click="toggleAnnotation(annotation.id)"
                  >
                    {{ annotation.name }}
                  </span>
                  <button class="edit-btn" @click.stop="openAnnotationEdit(annotation.id)">
                    ÁºñËæë
                  </button>
                </div>
              </div>
            </div>
          </section>
        </main>
      </div>

      <!-- Â±ÇÁ∫ßÁºñËæëÊ®°ÊÄÅÊ°Ü -->
      <div v-if="editingLayer" class="modal-backdrop" @click.self="closeLayerEdit">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title">ÁºñËæëÂ±ÇÁ∫ßÔºö{{ editingLayer.name }}</h3>
            <button class="modal-close" @click="closeLayerEdit">√ó</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label class="form-label">Â±ÇÁ∫ßÂêçÁß∞</label>
              <input
                v-model="editingLayer.name"
                type="text"
                class="form-input"
                placeholder="ËæìÂÖ•Â±ÇÁ∫ßÂêçÁß∞"
              />
            </div>
            <div class="form-group">
              <label class="form-label">ÈªòËÆ§È¢úËâ≤</label>
              <input
                v-model="editingLayer.defaultColor"
                type="color"
                class="form-input"
              />
            </div>
            <div class="form-group">
              <label class="form-label">Êó∂Èó¥ÊÆµÂàóË°®</label>
              <div class="ranges-list">
                <div
                  v-for="(range, index) in editingLayer.ranges"
                  :key="index"
                  class="range-item"
                >
                  <div class="range-item-header">
                    <span>{{ index + 1 }}. {{ range.label || "Êú™ÂëΩÂêçÊó∂Èó¥ÊÆµ" }}</span>
                    <button class="btn-danger" @click="removeRange(index)">Âà†Èô§</button>
                  </div>
                  <div class="range-item-fields">
                    <div>
                      <label class="form-label">Ëµ∑ÂßãÊó•Êúü</label>
                      <input
                        v-model="range.startDate"
                        type="date"
                        class="form-input"
                      />
                    </div>
                    <div>
                      <label class="form-label">ÁªìÊùüÊó•Êúü</label>
                      <input
                        v-model="range.endDate"
                        type="date"
                        class="form-input"
                      />
                    </div>
                  </div>
                  <div class="range-item-fields full-width">
                    <div>
                      <label class="form-label">Ê†áÁ≠æ</label>
                      <input
                        v-model="range.label"
                        type="text"
                        class="form-input"
                        placeholder="ËæìÂÖ•Êó∂Èó¥ÊÆµÊ†áÁ≠æ"
                      />
                    </div>
                  </div>
                  <div class="range-item-fields two-col">
                    <div>
                      <label class="form-label">È¢úËâ≤</label>
                      <input
                        v-model="range.color"
                        type="color"
                        class="form-input"
                      />
                    </div>
                  </div>
                </div>
              </div>
              <button class="btn-add" @click="addRange">
                <span>+</span>
                <span>Ê∑ªÂä†Êó∂Èó¥ÊÆµ</span>
              </button>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn-secondary" @click="closeLayerEdit">ÂèñÊ∂à</button>
            <button class="btn-primary" @click="saveLayerEdit">‰øùÂ≠ò</button>
          </div>
        </div>
      </div>

      <!-- Ê†áÊ≥®ÁºñËæëÊ®°ÊÄÅÊ°Ü -->
      <div v-if="editingAnnotation" class="modal-backdrop" @click.self="closeAnnotationEdit">
        <div class="modal-content" style="max-width: 500px">
          <div class="modal-header">
            <h3 class="modal-title">ÁºñËæëÊ†áÊ≥®Ôºö{{ editingAnnotation.name }}</h3>
            <button class="modal-close" @click="closeAnnotationEdit">√ó</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label class="form-label">Ê†áÊ≥®ÂêçÁß∞</label>
              <input
                v-model="editingAnnotation.name"
                type="text"
                class="form-input"
                placeholder="ËæìÂÖ•Ê†áÊ≥®ÂêçÁß∞"
              />
            </div>
            <div class="form-group">
              <label class="form-label">ÂõæÊ†á</label>
              <input
                v-model="editingAnnotation.icon"
                type="text"
                class="form-input"
                placeholder="ËæìÂÖ•ÂõæÊ†áÔºàemoji Êàñ UnicodeÔºâ"
                maxlength="2"
              />
            </div>
            <div class="form-group">
              <label class="form-label">‰∫ã‰ª∂ÂàóË°®</label>
              <div class="events-list">
                <div
                  v-for="(event, index) in editingAnnotation.events"
                  :key="index"
                  class="event-item"
                >
                  <div class="event-item-header">
                    <span>{{ index + 1 }}. {{ event.label || "Êú™ÂëΩÂêç‰∫ã‰ª∂" }}</span>
                    <button class="btn-danger" @click="removeEvent(index)">Âà†Èô§</button>
                  </div>
                  <div class="event-item-fields">
                    <div>
                      <label class="form-label">Êó•Êúü</label>
                      <input
                        v-model="event.date"
                        type="date"
                        class="form-input"
                      />
                    </div>
                    <div>
                      <label class="form-label">Ê†áÁ≠æ</label>
                      <input
                        v-model="event.label"
                        type="text"
                        class="form-input"
                        placeholder="ËæìÂÖ•‰∫ã‰ª∂Ê†áÁ≠æ"
                      />
                    </div>
                  </div>
                  <div class="event-item-fields">
                    <div>
                      <label class="form-label">ÂõæÊ†á</label>
                      <input
                        v-model="event.icon"
                        type="text"
                        class="form-input"
                        placeholder="ËæìÂÖ•ÂõæÊ†á"
                        maxlength="2"
                      />
                    </div>
                  </div>
                </div>
              </div>
              <button class="btn-add" @click="addEvent">
                <span>+</span>
                <span>Ê∑ªÂä†‰∫ã‰ª∂</span>
              </button>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn-secondary" @click="closeAnnotationEdit">ÂèñÊ∂à</button>
            <button class="btn-primary" @click="saveAnnotationEdit">‰øùÂ≠ò</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Vue 3 CDN -->
    <!-- 
      Ê≥®ÊÑèÔºöÂ¶ÇÈúÄÂÆåÂÖ®Á¶ªÁ∫øËøêË°åÔºåËØ∑‰∏ãËΩΩ vue.global.prod.js Âà∞Êú¨Âú∞Âπ∂ÊõøÊç¢Ê≠§ÈìæÊé•
      ‰∏ãËΩΩÂú∞ÂùÄÔºöhttps://unpkg.com/vue@3/dist/vue.global.prod.js
    -->
    <script src="./vue.global.prod.js"></script>
    <script>
      const { createApp, ref, computed, watch } = Vue;

      createApp({
        setup() {
          const SCHEMA_VERSION = 1;
          const STORAGE_KEY = "lifeInWeeks.state.v1";

          // Âü∫Á°ÄÊï∞ÊçÆ
          const birthDate = ref("2000-01-16");
          const totalWeeks = ref(4356);
          const ageYears = ref(84);
          const colsPerRow = ref(66);
          const hasData = ref(false);
          const gridEl = ref(null);
          const currentWeekIndex = ref(0);
          const birthDateObj = ref(null);
          const importInput = ref(null);

          // ÁºñËæëÁä∂ÊÄÅ
          const editingLayer = ref(null);
          const editingAnnotation = ref(null);

          // Â±ÇÁ∫ßÁ≥ªÁªüÊï∞ÊçÆÔºàdummy dataÔºâ
          const layers = ref([
            {
              id: "education",
              name: "ÊïôËÇ≤Èò∂ÊÆµ",
              active: false,
              defaultColor: "#667eea",
              color: "linear-gradient(135deg, #667eea 0%, #764ba2 100%)",
              ranges: [
                {
                  start: 312,
                  end: 624,
                  label: "Â∞èÂ≠¶ÊúüÈó¥",
                  color: "#667eea",
                  startDate: "",
                  endDate: "",
                },
                {
                  start: 624,
                  end: 936,
                  label: "‰∏≠Â≠¶ÊúüÈó¥",
                  color: "#764ba2",
                  startDate: "",
                  endDate: "",
                },
                {
                  start: 936,
                  end: 1048,
                  label: "Â§ßÂ≠¶ÊúüÈó¥",
                  color: "#f093fb",
                  startDate: "",
                  endDate: "",
                },
              ],
            },
            {
              id: "work",
              name: "Â∑•‰ΩúÈò∂ÊÆµ",
              active: false,
              defaultColor: "#fa709a",
              color: "linear-gradient(135deg, #fa709a 0%, #fee140 100%)",
              ranges: [
                {
                  start: 1130,
                  end: 1213,
                  label: "Á¨¨‰∏Ä‰ªΩÂ∑•‰Ωú",
                  color: "#fa709a",
                  startDate: "",
                  endDate: "",
                },
                {
                  start: 1213,
                  end: 1390,
                  label: "Á¨¨‰∫å‰ªΩÂ∑•‰Ωú",
                  color: "#fee140",
                  startDate: "",
                  endDate: "",
                },
                {
                  start: 1391,
                  end: 1417,
                  label: "Êµ∑Â§ñÈ©ªÂú®",
                  color: "#ee8f1e",
                  startDate: "",
                  endDate: "",
                },
                {
                  start: 1418,
                  end: 2808,
                  label: "Á¨¨‰∏â‰ªΩÂ∑•‰Ωú",
                  color: "#fee140",
                  startDate: "",
                  endDate: "",
                },
              ],
            },
            {
              id: "location",
              name: "Â±Ö‰ΩèÂú∞",
              active: false,
              defaultColor: "#a8edea",
              color: "linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)",
              ranges: [
                {
                  start: 0,
                  end: 872,
                  label: "Âåó‰∫¨",
                  color: "#a8edea",
                  startDate: "",
                  endDate: "",
                },
                {
                  start: 872,
                  end: 1242,
                  label: "‰∏äÊµ∑",
                  color: "#fed6e3",
                  startDate: "",
                  endDate: "",
                },
                {
                  start: 1242,
                  end: 4680,
                  label: "Êµ∑Â§ñ",
                  color: "#ffecd2",
                  startDate: "",
                  endDate: "",
                },
              ],
            },
          ]);

          // Ê†áÊ≥®Á≥ªÁªüÊï∞ÊçÆÔºàdummy dataÔºâ
          const annotations = ref([
            {
              id: "milestones",
              name: "ÈáçË¶Å‰∫ã‰ª∂",
              active: false,
              icon: "‚≠ê",
              events: [
                { week: 936, label: "È´ò‰∏≠ÊØï‰∏ö", icon: "üéì", date: "" },
                { week: 1196, label: "Â§ßÂ≠¶ÊØï‰∏ö", icon: "üéì", date: "" },
                { week: 1213, label: "ÂÖ•ËÅå", icon: "üíº", date: "" },
                { week: 2080, label: "ÁªìÂ©ö", icon: "üíç", date: "" },
                { week: 2600, label: "Êç¢Â∑•‰Ωú", icon: "üîÑ", date: "" },
              ],
            },
            {
              id: "travel",
              name: "ÊóÖË°å",
              active: false,
              icon: "‚úàÔ∏è",
              events: [
                { week: 1200, label: "Êó•Êú¨ÊóÖË°å", icon: "üóæ", date: "" },
                { week: 1500, label: "Ê¨ßÊ¥≤ÊóÖË°å", icon: "üèõÔ∏è", date: "" },
                { week: 2200, label: "‰∏úÂçó‰∫öÊóÖË°å", icon: "üèùÔ∏è", date: "" },
                { week: 3000, label: "ÁæéÂõΩÊóÖË°å", icon: "üóΩ", date: "" },
              ],
            },
            {
              id: "health",
              name: "ÂÅ•Â∫∑ËÆ∞ÂΩï",
              active: false,
              icon: "üè•",
              events: [
                { week: 1000, label: "Âπ¥Â∫¶‰ΩìÊ£Ä", icon: "üè•", date: "" },
                { week: 2000, label: "Âπ¥Â∫¶‰ΩìÊ£Ä", icon: "üè•", date: "" },
                { week: 3000, label: "Âπ¥Â∫¶‰ΩìÊ£Ä", icon: "üè•", date: "" },
              ],
            },
          ]);

          // Âë®Êï∞ÊçÆ
          const weeks = computed(() => {
            if (!hasData.value) return [];
            const count = Math.max(currentWeekIndex.value + 1, totalWeeks.value);
            return Array.from({ length: count }, (_, i) => ({
              index: i,
              isPast: i < currentWeekIndex.value,
              isCurrent: i === currentWeekIndex.value,
            }));
          });

          // Grid Ê†∑Âºè
          const gridStyle = computed(() => {
            if (!gridEl.value) return {};
            const wrapper = gridEl.value.closest(".grid-wrapper");
            const wrapperWidth = wrapper ? wrapper.clientWidth : 800;
            const innerWidth = Math.max(0, wrapperWidth - 20);
            const gap = 1;
            const cellSize = Math.max(
              6,
              Math.floor((innerWidth - (colsPerRow.value - 1) * gap) / colsPerRow.value)
            );
            return {
              "--cols": colsPerRow.value,
              "--gap": `${gap}px`,
              "--cell-size": `${cellSize}px`,
            };
          });

          // ËÆ°ÁÆóÂë®Á¥¢ÂºïÔºà‰ªéÂá∫ÁîüÊó•ÊúüÂà∞Áé∞Âú®ÁöÑÂë®Êï∞Ôºâ
          function diffInWeeks(start, end) {
            const ms = end.getTime() - start.getTime();
            const days = ms / (1000 * 60 * 60 * 24);
            return Math.floor(days / 7);
          }

          // Êó•ÊúüËΩ¨Âë®Á¥¢Âºï
          function dateToWeekIndex(dateStr) {
            if (!dateStr || !birthDateObj.value) return 0;
            const date = new Date(dateStr);
            if (Number.isNaN(date.getTime())) return 0;
            return Math.max(0, diffInWeeks(birthDateObj.value, date));
          }

          // Âë®Á¥¢ÂºïËΩ¨Êó•ÊúüÔºàËøîÂõûËØ•Âë®Á¨¨‰∏ÄÂ§©ÁöÑÊó•ÊúüÔºâ
          function weekIndexToDate(weekIndex) {
            if (!birthDateObj.value) return "";
            const date = new Date(birthDateObj.value);
            date.setDate(date.getDate() + weekIndex * 7);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, "0");
            const day = String(date.getDate()).padStart(2, "0");
            return `${year}-${month}-${day}`;
          }

          // ÁîüÊàêÁΩëÊ†º
          function generateGrid() {
            if (!birthDate.value) return;
            const birth = new Date(birthDate.value);
            if (Number.isNaN(birth.getTime())) return;
            birthDateObj.value = birth;
            const now = new Date();
            currentWeekIndex.value = Math.max(0, diffInWeeks(birth, now));
            hasData.value = true;
            // ÂàùÂßãÂåñÊó•ÊúüÂ≠óÊÆµ
            initializeDates();
            saveState();
          }

          // ÂàùÂßãÂåñÊó•ÊúüÂ≠óÊÆµÔºàÂ∞ÜÂë®Á¥¢ÂºïËΩ¨Êç¢‰∏∫Êó•ÊúüÔºâ
          function initializeDates() {
            if (!birthDateObj.value) return;

            // ÂàùÂßãÂåñÂ±ÇÁ∫ßÁöÑÊó∂Èó¥ÊÆµÊó•Êúü
            layers.value.forEach((layer) => {
              layer.ranges.forEach((range) => {
                if (!range.startDate) {
                  range.startDate = weekIndexToDate(range.start);
                }
                if (!range.endDate) {
                  range.endDate = weekIndexToDate(range.end);
                }
              });
            });

            // ÂàùÂßãÂåñÊ†áÊ≥®ÁöÑ‰∫ã‰ª∂Êó•Êúü
            annotations.value.forEach((annotation) => {
              annotation.events.forEach((event) => {
                if (!event.date) {
                  event.date = weekIndexToDate(event.week);
                }
              });
            });
          }

          // ÊûÑÂª∫ÂèØÊåÅ‰πÖÂåñÁä∂ÊÄÅ
          function buildPersistedState() {
            return {
              meta: {
                schemaVersion: SCHEMA_VERSION,
              },
              settings: {
                birthDate: birthDate.value,
                totalWeeks: totalWeeks.value,
                colsPerRow: colsPerRow.value,
              },
              layers: layers.value.map((layer) => ({
                id: layer.id,
                name: layer.name,
                defaultColor: layer.defaultColor,
                color: layer.color,
                ranges: layer.ranges.map((range) => ({
                  start: range.start,
                  end: range.end,
                  label: range.label,
                  color: range.color,
                })),
              })),
              annotations: annotations.value.map((annotation) => ({
                id: annotation.id,
                name: annotation.name,
                icon: annotation.icon,
                events: annotation.events.map((event) => ({
                  week: event.week,
                  label: event.label,
                  icon: event.icon,
                  date: event.date,
                })),
              })),
            };
          }

          function applyPersistedState(state) {
            if (!state || !state.meta || state.meta.schemaVersion !== SCHEMA_VERSION) {
              return;
            }

            try {
              const settings = state.settings || {};
              if (settings.birthDate) {
                birthDate.value = settings.birthDate;
              }
              if (Number.isFinite(settings.totalWeeks)) {
                totalWeeks.value = settings.totalWeeks;
              }
              if (Number.isFinite(settings.colsPerRow) && settings.colsPerRow > 0) {
                colsPerRow.value = settings.colsPerRow;
              }

              if (Array.isArray(state.layers) && state.layers.length > 0) {
                layers.value = state.layers.map((layer) => ({
                  id: layer.id,
                  name: layer.name,
                  active: false,
                  defaultColor: layer.defaultColor,
                  color: layer.color || layer.defaultColor,
                  ranges: Array.isArray(layer.ranges)
                    ? layer.ranges.map((range) => {
                        let start = Number(range.start) || 0;
                        let end = Number(range.end) || 0;
                        if (start > end) [start, end] = [end, start];
                        return {
                          start,
                          end,
                          label: range.label || "Êú™ÂëΩÂêçÊó∂Èó¥ÊÆµ",
                          color: range.color || layer.defaultColor,
                          startDate: "",
                          endDate: "",
                        };
                      })
                    : [],
                }));
              }

              if (Array.isArray(state.annotations) && state.annotations.length > 0) {
                annotations.value = state.annotations.map((annotation) => ({
                  id: annotation.id,
                  name: annotation.name,
                  active: false,
                  icon: annotation.icon,
                  events: Array.isArray(annotation.events)
                    ? annotation.events.map((event) => {
                        let week = typeof event.week === "number" ? event.week : 0;
                        if (!Number.isFinite(week) && event.date) {
                          week = dateToWeekIndex(event.date);
                        }
                        const safeWeek = Number.isFinite(week) && week >= 0 ? week : 0;
                        const date =
                          event.date ||
                          (Number.isFinite(week) ? weekIndexToDate(safeWeek) : "");
                        return {
                          week: safeWeek,
                          label: event.label || "Êú™ÂëΩÂêç‰∫ã‰ª∂",
                          icon: event.icon || annotation.icon,
                          date,
                        };
                      })
                    : [],
                }));
              }

              if (birthDate.value) {
                const birth = new Date(birthDate.value);
                if (!Number.isNaN(birth.getTime())) {
                  birthDateObj.value = birth;
                  const now = new Date();
                  currentWeekIndex.value = Math.max(0, diffInWeeks(birth, now));
                  hasData.value = true;
                  initializeDates();
                }
              }
            } catch (err) {
              console.error("Failed to apply persisted state:", err);
            }
          }

          function saveState() {
            try {
              const state = buildPersistedState();
              window.localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            } catch (err) {
              console.error("Failed to save state:", err);
            }
          }

          function loadPersistedState() {
            try {
              const raw = window.localStorage.getItem(STORAGE_KEY);
              if (!raw) return;
              const state = JSON.parse(raw);
              applyPersistedState(state);
            } catch (err) {
              console.error("Failed to load state:", err);
            }
          }

          // ÊâìÂºÄÂ±ÇÁ∫ßÁºñËæë
          function openLayerEdit(layerId) {
            const layer = layers.value.find((l) => l.id === layerId);
            if (!layer) return;
            // ÂàõÂª∫‰∏¥Êó∂ÂâØÊú¨
            editingLayer.value = JSON.parse(JSON.stringify(layer));
            // Á°Æ‰øùÊó•ÊúüÂ≠óÊÆµÂ∑≤ÂàùÂßãÂåñ
            editingLayer.value.ranges.forEach((range) => {
              if (!range.startDate) {
                range.startDate = weekIndexToDate(range.start);
              }
              if (!range.endDate) {
                range.endDate = weekIndexToDate(range.end);
              }
            });
          }

          // ÂÖ≥Èó≠Â±ÇÁ∫ßÁºñËæë
          function closeLayerEdit() {
            editingLayer.value = null;
          }

          // ‰øùÂ≠òÂ±ÇÁ∫ßÁºñËæë
          function saveLayerEdit() {
            if (!editingLayer.value) return;
            const layer = layers.value.find((l) => l.id === editingLayer.value.id);
            if (!layer) return;

            // Êõ¥Êñ∞Â±ÇÁ∫ßÂü∫Êú¨‰ø°ÊÅØ
            layer.name = editingLayer.value.name;
            layer.defaultColor = editingLayer.value.defaultColor;

            // Êõ¥Êñ∞Êó∂Èó¥ÊÆµÊï∞ÊçÆÔºàÂ∞ÜÊó•ÊúüËΩ¨Êç¢‰∏∫Âë®Á¥¢ÂºïÔºâ
            layer.ranges = editingLayer.value.ranges.map((range) => {
              let start = dateToWeekIndex(range.startDate);
              let end = dateToWeekIndex(range.endDate);
              let startDate = range.startDate;
              let endDate = range.endDate;
              // Â¶ÇÊûúËµ∑ÂßãÊó•ÊúüÂ§ß‰∫éÁªìÊùüÊó•ÊúüÔºåËá™Âä®‰∫§Êç¢
              if (start > end) {
                [start, end] = [end, start];
                [startDate, endDate] = [endDate, startDate];
              }
              return {
                start,
                end,
                label: range.label || "Êú™ÂëΩÂêçÊó∂Èó¥ÊÆµ",
                color: range.color || layer.defaultColor,
                startDate,
                endDate,
              };
            });

            closeLayerEdit();
            saveState();
          }

          // Ê∑ªÂä†Êó∂Èó¥ÊÆµ
          function addRange() {
            if (!editingLayer.value) return;
            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, "0")}-${String(today.getDate()).padStart(2, "0")}`;
            editingLayer.value.ranges.push({
              start: 0,
              end: 0,
              label: "",
              color: editingLayer.value.defaultColor || "#667eea",
              startDate: todayStr,
              endDate: todayStr,
            });
          }

          // Âà†Èô§Êó∂Èó¥ÊÆµ
          function removeRange(index) {
            if (!editingLayer.value) return;
            editingLayer.value.ranges.splice(index, 1);
          }

          // ÊâìÂºÄÊ†áÊ≥®ÁºñËæë
          function openAnnotationEdit(annotationId) {
            const annotation = annotations.value.find((a) => a.id === annotationId);
            if (!annotation) return;
            // ÂàõÂª∫‰∏¥Êó∂ÂâØÊú¨
            editingAnnotation.value = JSON.parse(JSON.stringify(annotation));
            // Á°Æ‰øùÊó•ÊúüÂ≠óÊÆµÂ∑≤ÂàùÂßãÂåñ
            editingAnnotation.value.events.forEach((event) => {
              if (!event.date) {
                event.date = weekIndexToDate(event.week);
              }
            });
          }

          // ÂÖ≥Èó≠Ê†áÊ≥®ÁºñËæë
          function closeAnnotationEdit() {
            editingAnnotation.value = null;
          }

          // ‰øùÂ≠òÊ†áÊ≥®ÁºñËæë
          function saveAnnotationEdit() {
            if (!editingAnnotation.value) return;
            const annotation = annotations.value.find(
              (a) => a.id === editingAnnotation.value.id
            );
            if (!annotation) return;

            // Êõ¥Êñ∞Ê†áÊ≥®Âü∫Êú¨‰ø°ÊÅØ
            annotation.name = editingAnnotation.value.name;
            annotation.icon = editingAnnotation.value.icon;

            // Êõ¥Êñ∞‰∫ã‰ª∂Êï∞ÊçÆÔºàÂ∞ÜÊó•ÊúüËΩ¨Êç¢‰∏∫Âë®Á¥¢ÂºïÔºâ
            annotation.events = editingAnnotation.value.events.map((event) => {
              const week = dateToWeekIndex(event.date);
              return {
                week,
                label: event.label || "Êú™ÂëΩÂêç‰∫ã‰ª∂",
                icon: event.icon || annotation.icon,
                date: event.date,
              };
            });

            closeAnnotationEdit();
            saveState();
          }

          // Ê∑ªÂä†‰∫ã‰ª∂
          function addEvent() {
            if (!editingAnnotation.value) return;
            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, "0")}-${String(today.getDate()).padStart(2, "0")}`;
            editingAnnotation.value.events.push({
              week: 0,
              label: "",
              icon: editingAnnotation.value.icon || "‚≠ê",
              date: todayStr,
            });
          }

          // Âà†Èô§‰∫ã‰ª∂
          function removeEvent(index) {
            if (!editingAnnotation.value) return;
            editingAnnotation.value.events.splice(index, 1);
          }

          // ESC ÈîÆÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
          function handleKeydown(e) {
            if (e.key === "Escape") {
              if (editingLayer.value) closeLayerEdit();
              if (editingAnnotation.value) closeAnnotationEdit();
            }
          }

          // Ëé∑ÂèñÂë®Ê†ºÁöÑ CSS Á±ª
          function getWeekCellClasses(week, index) {
            const classes = [];
            if (week.isPast) classes.push("past");
            if (week.isCurrent) classes.push("current");
            return classes;
          }

          // Ëé∑ÂèñÂë®Ê†ºÁöÑÊ†∑ÂºèÔºàÂ±ÇÁ∫ßÈ¢úËâ≤Ôºâ
          function getWeekCellStyle(week, index) {
            // Ëé∑ÂèñÊâÄÊúâÊøÄÊ¥ªÁöÑÂ±ÇÁ∫ßÔºåÊåâÊï∞ÁªÑÈ°∫Â∫èÔºà‰ªé‰∏ãÂæÄ‰∏äÔºâ
            // Êï∞ÁªÑË∂äÈù†ÂêéÁöÑÂ±ÇÁ∫ßË∂ä‰ºòÂÖàÔºà‰∏äÂ±ÇË¶ÜÁõñ‰∏ãÂ±ÇÔºâ
            const activeLayers = layers.value.filter((layer) => layer.active);
            
            // ‰ªé‰∏ãÂæÄ‰∏äÈÅçÂéÜÔºåÊâæÂà∞Á¨¨‰∏Ä‰∏™ÂåπÈÖçÁöÑÊó∂Èó¥ÊÆµÔºà‰∏äÂ±ÇË¶ÜÁõñ‰∏ãÂ±ÇÔºâ
            for (const layer of activeLayers) {
              const range = layer.ranges.find(
                (r) => index >= r.start && index <= r.end
              );
              if (range) {
                // Â¶ÇÊûúÂΩìÂâçÂë®Ôºå‰øùÊåÅÈ´ò‰∫ÆÔºå‰ΩÜËÉåÊôØÁî®Â±ÇÁ∫ßÈ¢úËâ≤
                if (week.isCurrent) {
                  return {
                    background: `radial-gradient(circle at top left, #ffc15a 0%, ${range.color} 70%)`,
                  };
                } else if (!week.isPast) {
                  return {};
                }
                return { background: range.color };
              }
            }
            return {};
          }

          // Ëé∑ÂèñËØ•Âë®ÁöÑÊâÄÊúâÊ†áÊ≥®
          function getWeekAnnotations(weekIndex) {
            const result = [];
            annotations.value.forEach((annotation) => {
              if (annotation.active) {
                annotation.events.forEach((event) => {
                  if (event.week === weekIndex) {
                    result.push({ label: event.label, icon: event.icon });
                  }
                });
              }
            });
            return result;
          }

          // ÂàáÊç¢Â±ÇÁ∫ßÔºàÊîØÊåÅÂ§öÈÄâÔºåÊåâÊï∞ÁªÑÈ°∫Â∫èÂè†Âä†Ôºå‰∏äÂ±ÇË¶ÜÁõñ‰∏ãÂ±ÇÔºâ
          function toggleLayer(layerId) {
            const layer = layers.value.find((l) => l.id === layerId);
            if (layer) {
              // Â§öÂ±ÇÁ∫ßÊøÄÊ¥ªÊ®°ÂºèÔºöÁÆÄÂçïÂàáÊç¢ÂΩìÂâçÂ±ÇÁ∫ßÁä∂ÊÄÅ
              layer.active = !layer.active;
            }
          }

          // ÂàáÊç¢Ê†áÊ≥®
          function toggleAnnotation(annotationId) {
            const annotation = annotations.value.find((a) => a.id === annotationId);
            if (annotation) {
              annotation.active = !annotation.active;
            }
          }

          // Âπ¥ÈæÑÂíåÂë®Êï∞ËÅîÂä®ÔºàÈÅøÂÖçÁõ∏‰∫í watch ÂØºËá¥ÁöÑ‰∫åÊ¨°‰øÆÊîπÔºâ
          let syncingFromAge = false;
          let syncingFromWeeks = false;

          watch(ageYears, (newVal) => {
            // Â¶ÇÊûúÊòØÁî± totalWeeks ÂêåÊ≠•ËøáÊù•ÁöÑÂèòÂåñÔºåÂàô‰∏çÂÜçÂèçÂêëÂÜôÂõû totalWeeks
            if (syncingFromWeeks) {
              syncingFromWeeks = false;
              return;
            }
            if (Number.isFinite(newVal) && newVal > 0) {
              syncingFromAge = true;
              totalWeeks.value = Math.round(newVal * 52);
            }
          });

          watch(totalWeeks, (newVal) => {
            // Â¶ÇÊûúÊòØÁî± ageYears ÂêåÊ≠•ËøáÊù•ÁöÑÂèòÂåñÔºåÂàô‰∏çÂÜçÂèçÂêëÂÜôÂõû ageYears
            if (syncingFromAge) {
              syncingFromAge = false;
              return;
            }
            if (Number.isFinite(newVal) && newVal > 0) {
              syncingFromWeeks = true;
              ageYears.value = Math.round(newVal / 52);
            }
          });

          // Á™óÂè£ resize Êó∂ÈáçÊñ∞ËÆ°ÁÆó
          let resizeTimer = null;
          window.addEventListener("resize", () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
              // Ëß¶ÂèëÈáçÊñ∞ËÆ°ÁÆó
              if (hasData.value) {
                generateGrid();
              }
            }, 120);
          });

          // ÂàùÂßãÂåñÂπ¥ÈæÑÊòæÁ§∫
          function syncAgeFromWeeks() {
            if (Number.isFinite(totalWeeks.value) && totalWeeks.value > 0) {
              ageYears.value = Math.round(totalWeeks.value / 52);
            }
          }

          loadPersistedState();
          if (!hasData.value) {
            syncAgeFromWeeks();
          }

          // Ê∑ªÂä†ÈîÆÁõò‰∫ã‰ª∂ÁõëÂê¨
          window.addEventListener("keydown", handleKeydown);

          // ÂØºÂÖ• / ÂØºÂá∫ / Ê∏ÖÈô§
          function handleImportClick() {
            if (importInput.value) {
              importInput.value.click();
            }
          }

          async function handleFileChange(event) {
            const file = event.target.files && event.target.files[0];
            if (!file) return;
            try {
              const text = await file.text();
              const state = JSON.parse(text);
              applyPersistedState(state);
              saveState();
            } catch (err) {
              console.error("Failed to import data:", err);
              window.alert("ÂØºÂÖ•Â§±Ë¥•ÔºöÊñá‰ª∂Ê†ºÂºè‰∏çÊ≠£Á°ÆÊàñÂ∑≤ÊçüÂùè„ÄÇ");
            } finally {
              event.target.value = "";
            }
          }

          function exportData() {
            try {
              const state = buildPersistedState();
              const blob = new Blob([JSON.stringify(state, null, 2)], {
                type: "application/json",
              });
              const url = URL.createObjectURL(blob);
              const a = document.createElement("a");
              const dateStr = new Date().toISOString().slice(0, 10);
              a.href = url;
              a.download = `life-in-weeks-${dateStr}.json`;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              URL.revokeObjectURL(url);
            } catch (err) {
              console.error("Failed to export data:", err);
              window.alert("ÂØºÂá∫Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï„ÄÇ");
            }
          }

          function clearData() {
            const confirmClear = window.confirm(
              "Á°ÆÂÆöË¶ÅÊ∏ÖÈô§Êú¨Âú∞ÊâÄÊúâÊï∞ÊçÆÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ"
            );
            if (!confirmClear) return;
            try {
              window.localStorage.removeItem(STORAGE_KEY);
            } catch (err) {
              console.error("Failed to clear local data:", err);
            }
            window.location.reload();
          }

          return {
            birthDate,
            totalWeeks,
            ageYears,
            colsPerRow,
            hasData,
            gridEl,
            weeks,
            gridStyle,
            layers,
            annotations,
            importInput,
            editingLayer,
            editingAnnotation,
            generateGrid,
            getWeekCellClasses,
            getWeekCellStyle,
            getWeekAnnotations,
            toggleLayer,
            toggleAnnotation,
            openLayerEdit,
            closeLayerEdit,
            saveLayerEdit,
            addRange,
            removeRange,
            openAnnotationEdit,
            closeAnnotationEdit,
            saveAnnotationEdit,
            addEvent,
            removeEvent,
            handleImportClick,
            handleFileChange,
            exportData,
            clearData,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
